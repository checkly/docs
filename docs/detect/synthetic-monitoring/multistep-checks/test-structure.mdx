---

title: 'Multistep Check Test Structure'
description: 'Learn how to structure your multistep checks with Playwright.'
sidebarTitle: Test Structure
---

<Tip>
**Monitoring as Code**: Learn more about the [Multistep Check Construct](/constructs/multistep-check).
</Tip>

## Multistep Check Test Structure

Multistep checks use Playwright's `test.step()` function to organize sequential operations:

```typescript
import { test, expect } from '@playwright/test'

test('Complete user onboarding workflow', async ({ request }) => {
  let userId, authToken, profileId

  await test.step('Register new user', async () => {
    const response = await request.post('/api/auth/register', {
      data: {
        email: 'newuser@example.com',
        password: 'SecurePass123!',
        firstName: 'John',
        lastName: 'Doe'
      }
    })
    
    expect(response.status()).toBe(201)
    const userData = await response.json()
    userId = userData.id
    expect(userId).toBeDefined()
  })

  await test.step('Verify email and activate account', async () => {
    const response = await request.post(`/api/auth/verify/${userId}`, {
      data: { verificationCode: 'TEST_CODE' }
    })
    
    expect(response.status()).toBe(200)
    const result = await response.json()
    authToken = result.token
    expect(authToken).toBeDefined()
  })

  await test.step('Complete user profile', async () => {
    const response = await request.post('/api/users/profile', {
      headers: { 'Authorization': `Bearer ${authToken}` },
      data: {
        company: 'Example Corp',
        role: 'Developer',
        preferences: { newsletter: true }
      }
    })
    
    expect(response.status()).toBe(201)
    const profile = await response.json()
    profileId = profile.id
    expect(profile.company).toBe('Example Corp')
  })

  await test.step('Verify complete onboarding', async () => {
    const response = await request.get(`/api/users/${userId}/status`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    })
    
    expect(response.status()).toBe(200)
    const status = await response.json()
    expect(status.onboardingComplete).toBe(true)
    expect(status.profileId).toBe(profileId)
  })
})
```

## API Request Capabilities

### HTTP Methods Support
```typescript
// GET requests
const response = await request.get('/api/users/123')

// POST requests with data
const response = await request.post('/api/users', {
  data: { name: 'John', email: 'john@example.com' }
})

// PUT/PATCH requests
const response = await request.patch('/api/users/123', {
  data: { status: 'active' }
})

// DELETE requests
const response = await request.delete('/api/users/123')

// Custom headers
const response = await request.get('/api/protected', {
  headers: {
    'Authorization': 'Bearer token123',
    'Content-Type': 'application/json',
    'X-API-Version': 'v2'
  }
})
```

### Request Configuration
```typescript
// Query parameters
const response = await request.get('/api/search', {
  params: {
    q: 'javascript',
    limit: 10,
    offset: 0
  }
})

// Form data
const response = await request.post('/api/upload', {
  form: {
    file: fs.readFileSync('document.pdf'),
    description: 'Important document'
  }
})

// JSON data
const response = await request.post('/api/data', {
  data: {
    items: [
      { id: 1, name: 'Item 1' },
      { id: 2, name: 'Item 2' }
    ]
  }
})
```

## Data Flow Between Steps

### Variable Passing
```typescript
test('E-commerce purchase workflow', async ({ request }) => {
  let authToken, cartId, orderId

  await test.step('User authentication', async () => {
    const response = await request.post('/api/auth/login', {
      data: {
        email: process.env.TEST_USER_EMAIL,
        password: process.env.TEST_USER_PASSWORD
      }
    })
    
    const auth = await response.json()
    authToken = auth.access_token
  })

  await test.step('Create shopping cart', async () => {
    const response = await request.post('/api/cart', {
      headers: { 'Authorization': `Bearer ${authToken}` },
      data: { items: [] }
    })
    
    const cart = await response.json()
    cartId = cart.id
  })

  await test.step('Add products to cart', async () => {
    const response = await request.post(`/api/cart/${cartId}/items`, {
      headers: { 'Authorization': `Bearer ${authToken}` },
      data: {
        productId: 'PROD_123',
        quantity: 2,
        price: 29.99
      }
    })
    
    expect(response.status()).toBe(201)
  })

  await test.step('Checkout and create order', async () => {
    const response = await request.post(`/api/cart/${cartId}/checkout`, {
      headers: { 'Authorization': `Bearer ${authToken}` },
      data: {
        paymentMethod: 'test_card',
        shippingAddress: {
          street: '123 Main St',
          city: 'Boston',
          zipCode: '02101'
        }
      }
    })
    
    const order = await response.json()
    orderId = order.id
    expect(order.status).toBe('confirmed')
  })

  await test.step('Verify order processing', async () => {
    const response = await request.get(`/api/orders/${orderId}`, {
      headers: { 'Authorization': `Bearer ${authToken}` }
    })
    
    const order = await response.json()
    expect(order.paymentStatus).toBe('paid')
    expect(order.fulfillmentStatus).toBe('pending')
  })
})
```

### Response Data Extraction
```typescript
await test.step('Extract and validate response data', async () => {
  const response = await request.get('/api/complex-data')
  const data = await response.json()
  
  // Extract nested data
  const userId = data.user.profile.id
  const permissions = data.user.roles.map(role => role.permissions).flat()
  const lastLoginDate = new Date(data.user.lastLogin)
  
  // Validate extracted data
  expect(userId).toBeGreaterThan(0)
  expect(permissions).toContain('read:profile')
  expect(lastLoginDate).toBeInstanceOf(Date)
  
  // Store for next steps
  return { userId, permissions, lastLoginDate }
})
```


## Environment Configuration

### Dynamic Configuration
```typescript
// Environment-specific configuration
const config = {
  baseURL: process.env.API_BASE_URL || 'https://api.example.com',
  authEndpoint: process.env.AUTH_ENDPOINT || '/api/auth/login',
  testUser: {
    email: process.env.TEST_USER_EMAIL,
    password: process.env.TEST_USER_PASSWORD
  }
}

test('Environment-aware workflow', async ({ request }) => {
  // Configure request defaults
  request = request.defaults({
    baseURL: config.baseURL,
    extraHTTPHeaders: {
      'User-Agent': 'Checkly-Multistep-Check/1.0'
    }
  })

  await test.step('Authenticate with environment credentials', async () => {
    const response = await request.post(config.authEndpoint, {
      data: config.testUser
    })
    
    expect(response.status()).toBe(200)
  })
})
```

## Integration and Deployment

### CLI Integration
```typescript
// checkly.config.ts
import { MultistepCheck, Frequency } from 'checkly/constructs'

new MultistepCheck('user-onboarding-flow', {
  name: 'User Onboarding Workflow',
  frequency: Frequency.EVERY_10M,
  locations: ['us-east-1', 'eu-west-1'],
  code: {
    entrypoint: './onboarding-workflow.spec.ts'
  },
  environmentVariables: [
    { key: 'API_BASE_URL', value: 'https://api.example.com' },
    { key: 'TEST_USER_EMAIL', value: '{{TEST_USER_EMAIL}}' }
  ]
})
```